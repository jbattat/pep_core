      SUBROUTINE VERF
      IMPLICIT NONE
C        PERFORM CARD BY CARD COMPARISON OF FILES 1 AND 2
C        INPUT IS ROUTED THROUGH SUBROUTINE 'CRD'.
C        ACTUAL CARD COMPARISON IS DONE IN ROUTINE 'CMP'
C        OUTPUT IS ROUTED THROUGH SUBROUTINE 'VDUMP'.
      include 'buffer.inc'
      include 'ibfl.inc'
      include 'pgfba.inc'
      include 'ptrs.inc'
C
      LOGICAL CMP
      INTEGER*4 LNJ(2), LNJ1, LNJ2
      EQUIVALENCE (LNJ(1),LNJ1),(LNJ(2),LNJ2)
      INTEGER*4 I,IDEC,IINC,IPJ,IPN,J,L,LNT1,LNT2,LNU1,LNU2,LNV1,LNV2,
     .          LN12
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C        RESET CHARACTER POINTER IF ANY RECORDS WERE SKIPPED
   10 DO 20 I=1,2
   20 LNJ(I)=MOD(LN(I),ISIZ)*JSIZ+ISUB1(I)
C        START HERE WHEN EXPECTING A MATCH
   30 IF(LN(1).GE.JP(1)) CALL CRD(1)
      IF(LN(2).GE.JP(2)) CALL CRD(2)
      IF(IRFM.EQ.0) GOTO 80
C           MUST DELETE OLD PAGE PTRS FRO PRINT FILES
      DO 70 I=1,2
      IF(IPNP(I).LE.1) GOTO 70
      IPN=IPNP(I)
      DO 40 J=1,IPN
      IF(LN(I).LT.KPGP(I,J)) GOTO 50
   40 CONTINUE
      J=IPN+1
   50 IPJ=J-2
      IF(IPJ.LE.0) GOTO 70
C           NOW MOVE BACK PTRS TO BE KEPT
      IPN=IPN-IPJ
      DO 60 J=1,IPN
   60 KPGP(I,J)=KPGP(I,J+IPJ)
      IPNP(I)=IPN
   70 CONTINUE
   80 IF(LN(1).GE.JP(1).OR.LN(2).GE.JP(2)) GOTO 220
C        NOW WE HAVE TWO CARDS TO COMPARE
      IF(.NOT.CMP(CBF(LNJ1),CBF(LNJ2))) GOTO 100
C        RECORDS MATCH, ADVANCE POINTERS AND CHECK NEXT
      DO 90 I=1,2
      LN(I)=LN(I)+1
      LNJ(I)=IINC(LNJ(I),I)
   90 CONTINUE
      GOTO 30
C        NON-MATCH, LOOK FOR NEXT MATCH
  100 LOOK=1
      LN12=LN(1)+LN(2)
      LNT1=LNJ1
      LNT2=LNJ2
C        LOOP ON 'LOOK' (NO. OF CARDS NEEDED IN CORE FOR COMPARISON)
  110 LOOKS=LOOK
      LOOK=LOOK+1
      IF(LOOK.LE.ISIZ) GOTO 130
      IF(IEF(1).EQ.1.AND.IEF(2).EQ.1) GOTO 140
C        BUFFER OVERFLOW, SOME MATCHING MAY BE LOST
      WRITE(6,120) ISIZ
  120 FORMAT('0***MORE THAN',I4,' NON-MATCHING CARDS, BEGINNING AS FOLLO
     1WS:')
      IP(1)=MIN0(JP(1)+1,LN(1)+5)
      IP(2)=MIN0(JP(2)+1,LN(2)+5)
      IF(NOPRNT.GT.1) NOPRNT=1
      GOTO 210
C        READ CARDS IF NECESSARY
  130 IF(LN(1)+LOOK.GT.JP(1)) CALL CRD(1)
      IF(LN(2)+LOOK.GT.JP(2)) CALL CRD(2)
C        SEE IF BOTH FILES AT EOF
  140 IF(JP(1)+JP(2)-LN12.LE.LOOK) GOTO 200
C        TRY AGAIN IF 1ST NON-MATCH MODIFIED BY OVERPRINTING
      IF(LOOK.EQ.1) GOTO 80
C        UPDATE SEARCH LIMIT
      IF(LOOK.GT.LOOKS) LNT1=IINC(LNT1,1)
C        COMPARE AT LEVEL 'LOOK',  'IP' AND 'LNU*' ARE EQUIVALENT
  144 IP(1)=LN(1)+LOOK
      IP(2)=LN(2)+1
      LNU1=LNT1
      LNU2=LNT2
      L=1
C SEE IF OFF THE END OF ONE
  150 IF(IP(1).LE.JP(1) .AND. CMP(CBF(LNU1),CBF(LNU2))) THEN
C MATCH FOUND AT IP(1) --- IP(2)
C MAKE SURE MATCH IS AT LEAST TWO CARDS IN A ROW
         LOOKS=LOOK-1
         DO 180 I=1,2
            IF(IP(I).LT.JP(I)) GOTO 180
C NEED TO READ NEXT CARD
            IF(LOOK.EQ.ISIZ) GOTO 190
            CALL CRD(I)
C DON'T INSIST IF A FILE HAS REACHED END
            IF(IP(I).GE.JP(I)) GOTO 190
  180       CONTINUE
         IF(LOOK.le.LOOKS) then
            LOOK=LOOK+1
C SOME OVERPRINTING HAPPENED, SEE IF STILL A MATCH
            IF(.NOT.CMP(CBF(LNU1),CBF(LNU2))) GOTO 144
         endif
C NOW TRY NEXT PAIR OF CARDS AFTER MATCH, KEEP LOOKING IF DIF.
         LNV1=IINC(LNU1,1)
         LNV2=IINC(LNU2,2)
         IF(CMP(CBF(LNV1),CBF(LNV2))) GOTO 190
      endif
C        STILL NO MATCH
      IP(1)=IP(1)-1
      IP(2)=IP(2)+1
C        SEE IF OFF THE END OF TWO
      IF(IP(2).GT.JP(2)) GOTO 110
      LNU1=IDEC(LNU1,1)
      LNU2=IINC(LNU2,2)
      L=L+1
      IF(L.LE.LOOK) GOTO 150
      GOTO 110
C FOUND A MATCH
  190 CALL VDUMP
      GOTO 10
C        NO MATCH UP TO END OF BOTH
  200 IP(1)=JP(1)+2
      IP(2)=JP(2)+2
  210 CALL VDUMP
      RETURN
C        ONE FILE EXHAUSTED
  220 DO 230 I=1,2
      IF(LN(I).LT.JP(I)) GOTO 240
  230 CONTINUE
C        BOTH EXHAUSTED
      IDMP=IDMP-1
      GOTO 200
C        ALL EXCESS OF THE REMAINING FILE IS 'NON-MATCHING'
  240 IP(3-I)=JP(3-I)+2
C        SET UP INDEFINITE VDUMP
      IP(I)=99999999
      GOTO 210
      END
